<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StyFit — Style Recommendations</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ------------------------------ General Styles ------------------------------ */
    :root {
        --primary: #4361ee; /* Vibrant blue */
        --secondary: #f72585; /* Energetic pink */
        --accent: #4cc9f0; /* Bright cyan */
        --neutral: #7209b7; /* Deep purple */
        --light: #f8f9fa; /* Light background */
        --dark: #1c2526; /* Dark text */
        --white: #ffffff; /* Pure white */
        --shadow: rgba(0,0,0,0.1);
        --transition: all 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
        font-family: 'Poppins', sans-serif;
        line-height: 1.6;
        color: var(--dark);
        background: var(--light);
        overflow-x: hidden;
    }

    a {
        text-decoration: none;
        color: var(--primary);
    }

    .container {
        width: 90%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
    }

    .btn {
        display: inline-block;
        padding: 12px 25px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        font-weight: 600;
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
    }

    .btn-secondary {
        background: var(--secondary);
        box-shadow: 0 4-5310px 15px rgba(247, 37, 133, 0.3);
    }

    .btn-secondary:hover {
        box-shadow: 0 6px 20px rgba(247, 37, 133, 0.4);
    }

    .text-center {
        text-align: center;
    }

    img {
        display: block;
        width: 100%;
        height: auto;
        object-fit: cover;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }
    
    .section-title{
        font-family:'Montserrat',sans-serif;
        color:#5a2bb0;
        margin-bottom:1rem
    }

    /* ------------------------------ Header & Hero ------------------------------ */
    header {
        background: var(--white);
        box-shadow: 0 2px 10px var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
    }

    .logo {
        font-family: 'Montserrat', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .hero {
        padding: 7rem 0;
        text-align: center;
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.9) 0%, rgba(114, 9, 183, 0.85) 100%), url('https://images.unsplash.com/photo-1490481651871-ab68de25d43d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
        color: var(--white);
        border-radius: 0 0 30px 30px;
        margin-bottom: 3rem;
        position: relative;
        overflow: hidden;
    }

    .hero h1 {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5rem;
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .hero p {
        font-size: 1.1rem;
        margin-bottom: 2rem;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        opacity: 0.9;
    }

    /* ------------------------------ App Specific Styles ------------------------------ */
    .controls {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .controls select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: all 0.2s ease;
    }

    .controls select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .upload-row {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .file-input {
        padding: 10px;
        border-radius: 8px;
        border: 1px dashed #ddd;
        background: white;
    }

    .note {
        font-size: 0.85rem;
        color: #666;
        text-align: center;
        margin-top: 6px;
    }

    .rec-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .rec-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .rec-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .rec-card img {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }
    
    .rec-content {
        padding: 1rem;
    }
    
    .small {
        font-size: 0.9rem;
        color: #444;
    }
    
    .swatches {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }
    
    .swatch {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 1px solid #eee;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    
    .center {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .loader {
        border: 4px solid rgba(0,0,0,0.06);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(3px);
        overflow: auto;
    }

    .modal-content {
        background: white;
        margin: 8% auto;
        padding: 2rem;
        border-radius: 16px;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        text-align: center;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .modal-content h2 {
        margin-bottom: 1rem;
        font-family: 'Montserrat', sans-serif;
    }
    
    .modal-content input,
    .modal-content select {
        width: 100%;
        margin: 0.5rem 0;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 0.95rem;
    }
    
    .modal-content button {
        width: 100%;
        margin-top: 1rem;
    }
    
    .close {
        float: right;
        font-size: 1.5rem;
        font-weight: bold;
        color: #444;
        cursor: pointer;
    }
    
    .close:hover { color: #000; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px);}
        to { opacity: 1; transform: translateY(0);}
    }

    /* Image Magnification Modal */
    #magnifyModal .modal-content {
        background: none;
        box-shadow: none;
        max-width: 90%;
        margin: 5% auto;
    }
    
    #magnifyImage {
        width: auto;
        max-width: 100%;
        height: auto;
        display: block;
        margin: auto;
        border-radius: 12px;
        animation: fadeIn 0.3s ease-in-out;
    }

    /* ------------------------------ Responsive Design ------------------------------ */
    @media (max-width: 768px) {
        .controls, .upload-row {
            flex-direction: column;
        }

        .hero h1 {
            font-size: 2rem;
        }

        .rec-grid {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <nav style="background:#007bff; padding:10px; border-radius:6px; margin-bottom:20px;">
  <a href="style.html" style="color:white; margin-right:15px; text-decoration:none; font-weight:bold;">Style Module</a>
  <a href="fitness.html" style="color:white; margin-right:15px; text-decoration:none; font-weight:bold;">Fitness Module</a>
  <a href="index.html" style="color:white; text-decoration:none; font-weight:bold;">Home</a>
  </nav>

  <header>
    <div class="container">
      <nav>
        <div class="logo">StyFit</div>
        <div>
          <button class="btn" id="loginBtn">Login</button>
          <button class="btn" id="signupBtn" style="margin-left:8px;background:#f72585">Sign Up</button>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <h1>Style recommendations — upload a photo and get curated outfits</h1>
        <p>We analyze color palette, body type and occasion to suggest outfits and makeup.</p>
      </div>
    </section>

    <section class="container" style="margin-top:1.5rem">
      <h2 class="section-title">Personalized Styling</h2>

      <div class="controls">
        <!-- Hardcoded dropdowns for a working app -->
        <select id="occasion">
          <option value="">Select occasion (optional)</option>
          <option value="Casual">Casual</option>
          <option value="Formal">Formal</option>
          <option value="Party">Party</option>
          <option value="Sporty">Sporty</option>
        </select>
        <select id="bodyType">
          <option value="">Body type (optional)</option>
          <option value="Athletic">Athletic</option>
          <option value="Hourglass">Hourglass</option>
          <option value="Pear">Pear</option>
          <option value="Inverted Triangle">Inverted Triangle</option>
          <option value="Rectangle">Rectangle</option>
        </select>
        <select id="skinTone">
          <option value="">Skin tone (for makeup & palette)</option>
          <option value="fair">Fair</option>
          <option value="medium">Medium</option>
          <option value="olive">Olive</option>
          <option value="deep">Deep</option>
        </select>
      </div>

      <div class="upload-row">
        <input id="uploadFileInput" class="file-input" type="file" accept="image/*" />
        <button class="btn" id="uploadRecommendBtn">Upload & Recommend</button>
        <div id="busy" style="display:none" class="center"><div class="loader"></div></div>
      </div>
      <div class="note">Tip: Use a clear full-body or outfit photo for the best suggestions.</div>
      
      <div id="paletteWrap" style="margin-top:1rem;display:none">
        <h3 class="small">Detected Color Palette</h3>
        <div id="paletteSwatches" class="swatches"></div>
      </div>
      
      <div id="makeupWrap" style="margin-top:1rem;display:none">
        <h3 class="small">Makeup Suggestions</h3>
        <div id="makeupList" class="small"></div>
      </div>

      <div id="recommendationsResult" class="rec-grid"></div>
    </section>
  </main>

  <footer style="padding:2rem;text-align:center;color:#666">
    &copy; 2025 StyFit. Styling-first demo.
  </footer>

  <!-- Magnify Modal -->
  <div id="magnifyModal" class="modal">
      <span class="close" onclick="closeModal('magnifyModal')">&times;</span>
      <img class="modal-content" id="magnifyImage" />
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('signupModal')">&times;</span>
      <h2>Create Account</h2>
      <form id="signupForm">
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="password" id="signupPassword" placeholder="Password (min 6 chars)" required>
        <input type="password" id="signupConfirm" placeholder="Confirm Password" required>
        <select id="signupBodyType" required>
          <option value="">Select Body Type</option>
          <option value="athletic">Athletic</option>
          <option value="hourglass">Hourglass</option>
          <option value="pear">Pear</option>
          <option value="inverted triangle">Inverted Triangle</option>
          <option value="rectangle">Rectangle</option>
        </select>
        <select id="signupSkinTone" required>
          <option value="">Select Skin Tone</option>
          <option value="fair">Fair</option>
          <option value="medium">Medium</option>
          <option value="olive">Olive</option>
          <option value="deep">Deep</option>
        </select>
        <button type="submit" class="btn">Sign Up</button>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('loginModal')">&times;</span>
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button type="submit" class="btn">Login</button>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('profileModal')">&times;</span>
      <h2>Your Profile</h2>
      <form id="profileForm">
        <input type="email" id="profileEmail" placeholder="Email" disabled>
        <select id="profileBodyType" required>
          <option value="">Select Body Type</option>
          <option value="athletic">Athletic</option>
          <option value="hourglass">Hourglass</option>
          <option value="pear">Pear</option>
          <option value="inverted triangle">Inverted Triangle</option>
          <option value="rectangle">Rectangle</option>
        </select>
        <select id="profileSkinTone" required>
          <option value="">Select Skin Tone</option>
          <option value="fair">Fair</option>
          <option value="medium">Medium</option>
          <option value="olive">Olive</option>
          <option value="deep">Deep</option>
        </select>
        <button type="submit" class="btn">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Message Box -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('messageModal')">&times;</span>
      <h2 id="messageTitle"></h2>
      <p id="messageText"></p>
    </div>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {

      // --- Firebase Configuration & Initialization ---
      const firebaseConfig = {
        apiKey: "AIzaSyCwEV8kfBMVX4wVia4eUq4fH2O-Zw_b_1w",
        authDomain: "my-styfit.firebaseapp.com",
        projectId: "my-styfit",
        appId: "1:511467920913:web:b580547c0c9d20002e9bb0"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const BACKEND_ORIGIN = "https://styfit-backend.onrender.com"; // Replace with your Render URL
      // --- Helper Functions ---
      async function showMessage(title, text) {
          document.getElementById('messageTitle').textContent = title;
          document.getElementById('messageText').textContent = text;
          openModal('messageModal');
      }

      window.openModal = id => { const m = document.getElementById(id); if (m) m.style.display = "block"; };
      window.closeModal = id => { const m = document.getElementById(id); if (m) m.style.display = "none"; };
      window.onclick = e => { if (e.target.classList.contains("modal")) e.target.style.display = "none"; };
      
      async function getIdToken() {
        const user = auth.currentUser;
        if (!user) { await showMessage("Error", "Please login first."); return null; }
        return await user.getIdToken(true);
      }
      
      function setBusy(on = true) {
        const busyEl = document.getElementById('busy');
        const btn = document.getElementById('uploadRecommendBtn');
        busyEl.style.display = on ? 'inline-flex' : 'none';
        btn.disabled = on;
      }
      
      const loginBtn = document.getElementById("loginBtn");
      const signupBtn = document.getElementById("signupBtn");

      // --- AUTHENTICATION ---
      // Listen for auth state changes
      onAuthStateChanged(auth, user => {
        if (user) {
          loginBtn.textContent = "Profile";
          loginBtn.onclick = openProfileModal;
          signupBtn.textContent = "Logout";
          signupBtn.style.background = "#dc3545";
          signupBtn.onclick = async () => {
            await signOut(auth);
            showMessage("Success", "Logged out.");
          };
        } else {
          loginBtn.textContent = "Login";
          loginBtn.onclick = () => openModal("loginModal");
          signupBtn.textContent = "Sign Up";
          signupBtn.style.background = "#f72585";
          signupBtn.onclick = () => openModal("signupModal");
        }
      });

      // Signup form submission
      const signupForm = document.getElementById("signupForm");
      if (signupForm) {
        signupForm.addEventListener("submit", async e => {
          e.preventDefault();
          const email = document.getElementById("signupEmail").value;
          const pwd = document.getElementById("signupPassword").value;
          const confirm = document.getElementById("signupConfirm").value;
          if (pwd !== confirm) { return await showMessage("Error", "Passwords don’t match."); }
          try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pwd);
            await setDoc(doc(db, "users", userCred.user.uid), {
              email,
              bodyType: document.getElementById("signupBodyType").value,
              skinTone: document.getElementById("signupSkinTone").value,
              createdAt: serverTimestamp()
            });
            closeModal("signupModal");
            await showMessage("Success", "Account created!");
          } catch (err) { await showMessage("Signup Error", err.message); }
        });
      }

      // Login form submission
      const loginForm = document.getElementById("loginForm");
      if (loginForm) {
        loginForm.addEventListener("submit", async e => {
          e.preventDefault();
          try {
            await signInWithEmailAndPassword(auth, document.getElementById("loginEmail").value, document.getElementById("loginPassword").value);
            closeModal("loginModal");
            await showMessage("Success", "Logged in successfully!");
          } catch (err) { await showMessage("Login Failed", err.message); }
        });
      }

      // Profile modal
      async function openProfileModal() {
        const user = auth.currentUser;
        if (!user) { return await showMessage("Error", "Please log in first."); }
        const snap = await getDoc(doc(db, "users", user.uid));
        const data = snap.exists() ? snap.data() : {};
        document.getElementById("profileEmail").value = user.email;
        document.getElementById("profileBodyType").value = data.bodyType || "";
        document.getElementById("profileSkinTone").value = data.skinTone || "";
        openModal("profileModal");
      }

      const profileForm = document.getElementById("profileForm");
      if (profileForm) {
        profileForm.addEventListener("submit", async e => {
          e.preventDefault();
          const user = auth.currentUser;
          await setDoc(doc(db, "users", user.uid), {
            bodyType: document.getElementById("profileBodyType").value,
            skinTone: document.getElementById("profileSkinTone").value,
            updatedAt: serverTimestamp()
          }, { merge: true });
          await showMessage("Success", "Profile updated!");
          closeModal("profileModal");
        });
      }

      // --- Backend API Calls & Logic ---
      const uploadInput = document.getElementById('uploadFileInput');
      const btn = document.getElementById('uploadRecommendBtn');
      const recWrap = document.getElementById('recommendationsResult');
      const paletteWrap = document.getElementById('paletteWrap');
      const paletteSwatches = document.getElementById('paletteSwatches');
      const makeupWrap = document.getElementById('makeupWrap');
      const makeupList = document.getElementById('makeupList');

      btn.addEventListener('click', async () => {
        const file = uploadInput.files[0];
        if (!file) return await showMessage("Error", "Please pick an image to upload.");

        try {
          setBusy(true);
          recWrap.innerHTML = "";
          paletteWrap.style.display = 'none';
          makeupWrap.style.display = 'none';

          // ✅ Ensure current user is logged in
          const user = auth.currentUser;
          if (!user) return await showMessage("Error", "Please login first.");

          // ✅ Get fresh ID token
          const idToken = await user.getIdToken(true);
          if (!idToken) return await showMessage("Error", "Could not get auth token. Try logging in again.");

          // --- Step 1: Upload the image ---
          const form = new FormData();
          form.append("file", file, file.name);

          const uploadRes = await fetch(`${BACKEND_ORIGIN}/upload`, {
            method: "POST",
            headers: { Authorization: `Bearer ${idToken}` }, // correct header
            body: form,
            mode: 'cors'
          });

          if (!uploadRes.ok) {
            const errText = await uploadRes.text();
            throw new Error(`Upload failed: ${uploadRes.status} - ${errText}`);
          }

          const uploadData = await uploadRes.json();
          const imageUrl = uploadData.url;

          // --- Step 2: Get style recommendations ---
          const occasion = document.getElementById('occasion').value;
          const bodyType = document.getElementById('bodyType').value;
          const skinTone = document.getElementById('skinTone').value;

          const recRes = await fetch(`${BACKEND_ORIGIN}/style/recommend`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${idToken}`
            },
            body: JSON.stringify({ imageUrl, occasion, bodyType }),
            mode: 'cors'
          });

          if (!recRes.ok) {
            const errText = await recRes.text();
            throw new Error(`Recommendation failed: ${recRes.status} - ${errText}`);
          }

          const recData = await recRes.json();
          renderRecommendations(recData.picks);

          // --- Step 3: Optional palette & makeup ---
          if (skinTone) {
            // Palette
            const paletteRes = await fetch(`${BACKEND_ORIGIN}/style/palette`, {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: `Bearer ${idToken}` },
              body: JSON.stringify({ skinTone }),
              mode: 'cors'
            });
            if (paletteRes.ok) renderPalette((await paletteRes.json()).palette);

            // Makeup
            const makeupRes = await fetch(`${BACKEND_ORIGIN}/style/makeup`, {
              method: "POST",
              headers: { "Content-Type": "application/json", Authorization: `Bearer ${idToken}` },
              body: JSON.stringify({ skinTone }),
              mode: 'cors'
            });
            if (makeupRes.ok) showMakeup((await makeupRes.json()).makeup);
          }

        } catch (e) {
          await showMessage("Request Error", e.message);
          console.error(e);
        } finally {
          setBusy(false);
        }
      });

      function renderPalette(arr) {
        paletteSwatches.innerHTML = "";
        if (!arr || arr.length === 0) { paletteWrap.style.display = 'none'; return; }
        arr.forEach(hex => {
          const d = document.createElement('div');
          d.className = 'swatch';
          d.style.background = hex;
          d.title = hex;
          paletteSwatches.appendChild(d);
        });
        paletteWrap.style.display = 'block';
      }
      
      function showMakeup(list) {
        makeupList.innerHTML = "";
        if (!list || list.length === 0) { makeupWrap.style.display = 'none'; return; }
        list.forEach(item => {
          const p = document.createElement('div');
          p.textContent = `${item.type || item.name || 'Shade'}: ${item.name || item}`;
          makeupList.appendChild(p);
        });
        makeupWrap.style.display = 'block';
      }
      
      function renderRecommendations(picks) {
        recWrap.innerHTML = "";
        if (!picks || picks.length === 0) {
          recWrap.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666">No recommendations found.</div>`;
          return;
        }

        picks.forEach(pick => {
          const c = document.createElement("div");
          c.className = "rec-card";

          const imageUrl = pick.imageUrl; // Fixed: using the correct URL from the backend

          c.innerHTML = `
            <img src="${imageUrl}" alt="${pick.category || ""}">
            <div class="rec-content">
              <h4 style="margin:0 0 6px">${pick.category || ""}</h4>
              <div class="small">${pick.brand || ""}</div>
              <div class="swatches" style="margin-top:8px">
                ${(pick.palette_match || [])
                  .map(hex => `<div class="swatch" style="background:${hex}" title="${hex}"></div>`)
                  .join("")}
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button class="btn" style="background:#6c757d" onclick="saveToCloset('${encodeURIComponent(JSON.stringify(pick))}')">Save</button>
              </div>
            </div>
          `;
          recWrap.appendChild(c);
          
          // Add event listener for magnification
          const imageEl = c.querySelector("img");
          imageEl.style.cursor = "pointer";
          imageEl.addEventListener('click', () => {
              const modal = document.getElementById('magnifyModal');
              const modalImg = document.getElementById('magnifyImage');
              modal.style.display = "block";
              modalImg.src = imageEl.src;
          });
        });
      }

      window.saveToCloset = async function(encodedPick) {
        try {
          const user = auth.currentUser;
          if (!user) { return await showMessage("Error", "Please login to save items."); }
          const pick = JSON.parse(decodeURIComponent(encodedPick));
          await addDoc(collection(db, "users", user.uid, "closet"), {
            brand: pick.brand,
            imageUrl: pick.imageUrl,
            savedAt: serverTimestamp()
          });
          await showMessage("Success", "Saved to your closet.");
        } catch (e) {
          await showMessage("Save Failed", e.message);
        }
      };
    });
  </script>

</body>
</html>
